map $request_uri $new_uri {
    ## library of custom redirects:
    include /home/gwern/gwern.net/static/redirects/nginx.conf;
}

## Rewrite https://gwern.net â†’ https://www.gwern.net
server {
    listen 80;
    server_name gwern.net;

    return 301 $scheme://www.gwern.net$request_uri;
    }

server {
    listen 80 default_server;
    server_name www.gwern.net;

     root /home/gwern/gwern.net;

     index /index;
     error_page 404 /static/404.html;

     default_type text/html;

     location / {

        ## support basic MIME types
        include  /etc/nginx/mime.types;
        ## support none-basic MIME types...
        types {
          text/markdown page;
          application/x-maff maff;
          text/plain conf;
          text/csv csv;
          text/x-adobe-acrobat-drm ebt;
          application/epub+zip epub;
          text/x-haskell hs;
          htm text/html;
          application/msaccess mdb;
          message/rfc822 mht;
          application/vnd.oasis.opendocument.text odt;
          application/vnd.oasis.opendocument.spreadsheet ods;
          application/vnd.oasis.opendocument.presentation odp;
          text/x-opml opml;
          text/x-patch patch;
          text/x-diff  diff;
          text/x-php php;
          text/x-r R;
          application/vnd.rn-realmedia rm;
          text/x-shellscript sh;
          application/x-tar tar;
          application/font-sfnt ttf;
          image/x-xcf xcf;
          application/x-xz xz;
          text/yaml yaml;
          audio/wav wav; }

        ## somewhat aggressive caching:
        add_header Cache-Control "max-age=77760000, public";

        ## allow directory browsing, particularly useful for /docs/*
        # autoindex on; # ERROR: redirects break it somehow

        ## replace all spaces with hyphens:
        rewrite ^(.*)(\s|%20)(.*)$ $1-$3 permanent;
        ## fix a bunch of very obxious crawlers:
        rewrite ^/docs/www/play\.google\.com/\_/ss/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/play\.google\.com/\_/js/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/play\.google\.com/\+/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/play\.google\.com/(?<original>.*) /$original permanent;
        rewrite ^/store/configure/xbox-design-lab/(?<original>.*) /$original permanent;
        rewrite ^/configure/(?<original>.*) /$original permanent;
        rewrite ^/b/(?<original>.*) /$original permanent;
        rewrite ^/source/LP.*/(?<original>.*) /$original permanent;
        rewrite ^/source/I0.*/(?<original>.*) /$original permanent;
        rewrite ^/satellites/bible/(?<original>.*) /$original permanent;
        rewrite ^/soylent/library/travel/cities/nyc/(?<original>.*) /$original permanent;
        rewrite ^/soylent/library/death/suicide/famous/(?<original>.*) /$original permanent;
        rewrite ^/m/(?<original>.*) /$original permanent;
        rewrite ^/amp/(?<original>.*) /$original permanent;
        rewrite ^/foo/(?<original>.*) /$original permanent;
        rewrite ^/p/(?<original>.*) /$original permanent;
        rewrite ^/docs/www\/free\.law/OPR/(?<original>.*) /$original permanent;
        rewrite ^/forum/(?<original>.*) /$original permanent;
        rewrite ^/choice/(?<original>.*) /$original permanent;
        rewrite ^/wp-content/(?<original>.*) /$original permanent;
        rewrite ^/stylesheets/(?<original>.*) /$original permanent;
        rewrite ^/products/(?<original>.*) /$original permanent;
        rewrite ^/performer/(?<original>.*) /$original permanent;
        rewrite ^/opinion/(?<original>.*) /$original permanent;
        rewrite ^/login/(?<original>.*) /$original permanent;
        rewrite ^/feature/(?<original>.*) /$original permanent;
        rewrite ^/event/(?<original>.*) /$original permanent;
        rewrite ^/advanced-search/(?<original>.*) /$original permanent;
        rewrite ^/cart/(?<original>.*) /$original permanent;
        rewrite ^/docs/2020-crc/(?<original>.*) /$original permanent;
        rewrite ^/docs/2010-crc/(?<original>.*) /$original permanent;
        rewrite ^/static/docs/(?<original>.*) /docs/$original permanent;
        rewrite ^/2017/11/20/(?<original>.*) /$original permanent;
        rewrite ^/Yoga.*/(?<original>.*) /$original permanent;
        rewrite ^/all-essays/(?<original>.*) /$original permanent;
        rewrite ^/Red/feed/(?<original>.*) /$original permanent;
        rewrite ^/Prediction-markets/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.upi.com/YWRzLmxmc3RtZWRpYS5jb20vZ2V0YWQ/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/yuki-onna.livejournal.com/www.arte.tv/en/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/yuki-onna.livejournal.com/flymeango.com/(?<original>.*) /$original permanent;
        rewrite ^/blog/chasing-10x-leveraging-a-poor-memory-in-software-engineering/(?<original>.*) /$original permanent;
        rewrite ^/blog/everything-i-know-strategies-tips-and-tricks-for-spaced-repetition-anki/(?<original>.*) /$original permanent;
        rewrite ^/about/(?<original>.*) /$original permanent;
        rewrite ^/BINARY/(?<original>.*) /$original permanent;
        rewrite ^/border-wall/(?<original>.*) /$original permanent;
        rewrite ^/card/(?<original>.*) /$original permanent;
        rewrite ^/component/(?<original>.*) /$original permanent;
        rewrite ^/contests/(?<original>.*) /$original permanent;
        rewrite ^/videos/(?<original>.*) /$original permanent;
        rewrite ^/trust/(?<original>.*) /$original permanent;
        rewrite ^/terms/(?<original>.*) /$original permanent;
        rewrite ^/s/(?<original>.*) /$original permanent;
        rewrite ^/k/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.sueddeutsche.de/edge/(?<original>.*) /$original permanent;
        rewrite ^/privacy/(?<original>.*) /$original permanent;
        rewrite ^/poisoned-cities/(?<original>.*) /$original permanent;
        rewrite ^/partner_content/(?<original>.*) /$original permanent;
        rewrite ^/my-account/(?<original>.*) /$original permanent;
        rewrite ^/live-blog/(?<original>.*) /$original permanent;
        rewrite ^/initiatives/(?<original>.*) /$original permanent;
        rewrite ^/in-depth/(?<original>.*) /$original permanent;
        rewrite ^/homepage-test/(?<original>.*) /$original permanent;
        rewrite ^/help/(?<original>.*) /$original permanent;
        rewrite ^/fonts/(?<original>.*) /$original permanent;
        rewrite ^/find_v2/(?<original>.*) /$original permanent;
        rewrite ^/sponsored/(?<original>.*) /$original permanent;
        rewrite ^/sponsored_sections/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/au.news.yahoo.com/Chrome/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/au.news.yahoo.com/Safari/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/brnensky.denik.cz/edge/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.adressa.no/Trident/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.belfastlive.co.uk/offline/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.dailymail.co.uk\/android-app\:\/\/com.dailymail.online/dailymail/article/2825778/(?<original>.*) /$original permanent;
        rewrite ^/docs/docs/(?<original>.*) /$original permanent;
        rewrite ^/docs/tags/(?<original>.*) /tags/$original permanent;
        rewrite ^/docs/iq/docs/(?<original>.*) /docs/$original permanent;
        rewrite ^/alternates/s615b/(?<original>.*) /$original permanent;
        rewrite ^/100-y/ALL/score/1/(?<original>.*) /$original permanent;

        ## it's very hard to fix broken '#' anchors since it's client-side, the web server isn't support to see it
        ## and I couldn't find any Nginx solution I understood, so we just strip the trailing garbage:
        rewrite ^(?<u>.*)\#(?<v>.*)     $u permanent;

        ## Strip all query-parameters which are meaningless on gwern.net & only yield 404s
        ## NOTE: '$args' = '?args' in 'foo.com/bar?args'
        set $args '';
     }

     ## Enable redirection? TODO: I don't understand why this seems to be necessary in addition to `map`
     if ($new_uri != "" ) {
        rewrite ^(.*)$ $new_uri permanent;
      }
}
